name: build & release

on:
  push:
    tags: ["v*"]
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64-linux, aarch64-linux, x86_64-macos, aarch64-macos]

    steps:
      - uses: actions/checkout@v6

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - run: |
          zig build-exe src/main.zig \
            -O ReleaseSmall \
            -target ${{ matrix.target }} \
            -fstrip \
            -femit-bin=fasttrack-${{ matrix.target }}

      - name: Test (Native Only)
        if: matrix.target == 'x86_64-linux'
        run: ./fasttrack-x86_64-linux --help

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: fasttrack-${{ matrix.target }}
          path: fasttrack-${{ matrix.target }}

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare Assets & Checksums
        run: |
          mkdir dist
          mv artifacts/fasttrack-* dist/
          cd dist
          sha256sum fasttrack-* > SHA256SUMS
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/fasttrack-*
            dist/SHA256SUMS
          generate_release_notes: true
          body: |
            ### Installation
            Download the binary for your platform and move it to your bin folder:
            `chmod +x fasttrack-<target> && mv fasttrack-<target> /usr/local/bin/fasttrack`

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: mlugg/setup-zig@v2

      - name: Check Formatting
        run: zig fmt --check .
